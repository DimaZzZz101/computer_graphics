<html lang="en">
<head>
    <meta charset="utf-8">

    <link rel="stylesheet" href="./css/workspace_style.css">

    <title>HomeWork02</title>

</head>

<body>
<h1>Homework 2. Median filter.</h1>

<canvas width="600" , height="600" , id="original"></canvas>
<canvas width="600" , height="600" , id="filtered"></canvas>

<input type="button" class="btn" id="btn_filter" value="Filter it!">

<script>
    // Пространство для 1го изображения.
    var canvas = document.getElementById("original");
    var ctx = canvas.getContext("2d");

    // Пространство для 2го изображения.
    var canvas2 = document.getElementById("filtered");
    var ctx2 = canvas2.getContext("2d");

    // Скачиваем исходное изображение.
    var img = new Image();
    img.crossOrigin = "anonymus";
    //img.src = "https://upload.wikimedia.org/wikipedia/commons/8/87/Highimgnoise.jpg";
    img.src = img.src = "https://upload.wikimedia.org/wikipedia/commons/f/f4/Noise_salt_and_pepper.png";
    // Интерфес для доступа к пикселям.
    var img_data = new ImageData(1, 1);

    img.onload = function () {
        // Вывод изображения в позиции (0; 0) на холсте и определение его ширины и высоты.
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        function doFilter() {
            // Получаем все пиксели изображения.
            img_data = ctx.getImageData(0, 0, canvas.width, canvas.height);

            var h = canvas2.height;
            var w = canvas2.width;

            var img2_data = ctx.createImageData(w, h);
            var row_size = 7;
            var col_size = 7;

            for (var i = 0; i < h; i++) {
                for (var j = 0; j < w; j++) {
                    const R = [];
                    const G = [];
                    const B = [];
                    const S = [];

                    for (var k = 0; k < col_size; k++) {
                        for (var l = 0; l < row_size; l++) {
                            R.push(img_data.data[((i + l) * w + j + k) * 4]);
                            G.push(img_data.data[((i + l) * w + j + k) * 4 + 1]);
                            B.push(img_data.data[((i + l) * w + j + k) * 4 + 2]);
                            S.push(img_data.data[((i + l) * w + j + k) * 4 + 3]);
                        }
                    }

                    R.sort();
                    G.sort();
                    B.sort();
                    S.sort();

                    var median = Math.floor(R.length / 2);

                    for (var k = 0; k < col_size; k++) {
                        for (var l = 0; l < row_size; l++) {
                            img2_data.data[((i + l) * w + j + k) * 4] = R[median];
                            img2_data.data[((i + l) * w + j + k) * 4 + 1] = G[median];
                            img2_data.data[((i + l) * w + j + k) * 4 + 2] = B[median];
                            img2_data.data[((i + l) * w + j + k) * 4 + 3] = S[median];
                        }
                    }
                }
            }
            ctx2.putImageData(img2_data, 0, 0, 0, 0, canvas2.width, canvas2.height);
        }

        var button_filter = document.getElementById('btn_filter');

        button_filter.addEventListener('click', doFilter);
    };
</script>
</body>
</html>
